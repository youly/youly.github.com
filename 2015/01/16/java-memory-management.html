

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Java内存管理</title>
    
    <meta name="author" content="Youly">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Youly</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">存档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  




            <!--
            <li><a href="/resume">简历</a></li>
            -->
            <li><a href="/photos">相册</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

<div class="page-header">
  <h1>Java内存管理 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>16 January 2015</span>
    </div>
    <div class="content">
      <h3 id="section">什么是内存管理</h3>

<p>内存管理包括内存的分配和回收。</p>

<p>在C++语言中内存管理是由程序员显式地来完成的，这通常导致一些常见的bug，如悬空指针引用和垃圾对象导致的内存泄露。java语言自从java 2开始就提供了自动内存管理的功能：垃圾回收器。</p>

<h3 id="section-1">运行时内存组成</h3>

<p>大致布局如下图（<a href="http://www.pointsoftware.ch/de/under-the-hood-runtime-data-areas-javas-memory-model/">来自</a>）：</p>

<p><img src="/assets/images/java_memory_layout.png" alt="类存布局" /></p>

<p>堆内存：所有线程共享，存储 new Objects，<em>对象信息</em></p>

<p>非堆内存，除了堆以外的内存，包括：</p>

<ul>
  <li>方法区：和堆一样，所有线程共享，存储加载的 <em>类</em> 描述信息（版本、字段、方法、接口等）、常量池、静态变量、即时编译的代码等数据。</li>
  <li>虚拟机栈：线程私有，存储局部变量表、操作数栈、动态链接、方法出口等信息。局部变量表存放了编译期可知的各种基本数据类型（ boolean、 byte、 char、 short、 int、 float、 long、 double）、 对象引用。</li>
  <li>本地方法栈：本地方法栈则为虚拟机使用到的Native方法服务。</li>
  <li>程序计数器：线程私有，记录每个线程当前执行字节码指令地址。</li>
</ul>

<p>具体布局如下图：
<img src="/assets/images/java_memory_layout_2.png" alt="类存布局" /></p>

<p>###堆内存管理
从垃圾的回收的角度来看，堆内存可以分为两个区域：</p>

<p>新生代：eden + from supvivor space</p>

<p>年老代：新生代中经过几次垃圾回收仍存活的对象 + eden中存放不下的大对象。</p>

<h3 id="section-2">垃圾回收器应该满足的特性</h3>
<p>1、正确性：有效数据保证永远不会被错误回收，垃圾数据不应该经过几轮垃圾回收后仍保留。</p>

<p>2、高效性：在保证应用程序不中断的情况下快速的回收垃圾。时间、空间、频次上达到一个平衡。</p>

<p>3、紧凑性：垃圾回收后不会产生过多的分片。</p>

<p>4、可扩展性：垃圾回收器不应该成为一个多核多线程应用程序中得一个性能瓶颈。</p>

<h3 id="section-3">分代回收</h3>
<p>新生代：内存小，收集频繁，要求时间利用率高</p>

<p>老年代：内存大，频次低，要求空间利用率高</p>

<h3 id="jvm">JVM启动参数设置</h3>

<p>-Xms，-Xmx：jvm初始化内存大小和最大内存大小，等于 年轻代大小 + 年老代大小 + 永久代大小 + 栈大小</p>

<p>-Xmn，-XX:NewSize：堆内存中年轻代内存大小。</p>

<p>-XX:MaxNewSize：堆内存中年轻代内存最大值。</p>

<p>-XX:MaxPermSize：永久代内存最大值。</p>

<p>-Xss：每个线程的堆栈大小。相同物理内存下，减小这个值能生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在3000~5000左右。</p>

<p>-XX:NewRatio：Ratio of old/new generation sizes. The default value is 2.</p>

<p>XX:SurvivorRatio：Ratio of eden/survivor space size. The default value is 8.</p>

<h3 id="section-4">参考</h3>
<p>1、<a href="http://www.oracle.com/technetwork/java/javase/memorymanagement-whitepaper-150215.pdf">Memory Management in the Java HotSpot™ Virtual Machine</a></p>

<p>2、<a href="http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-2.html">The Structure of the Java Virtual Machine</a></p>

<p>3、<a href="http://docs.oracle.com/cd/E22289_01/html/821-1274/configuring-the-default-jvm-and-java-arguments.html">Configuring the Default JVM and Java Arguments</a></p>

<p>4、<a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">Java HotSpot VM Options</a></p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#java-ref">
    		java <span>5</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#java-ref">java <span>8</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2015/01/05/b-tree" title="数据结构：B-tree">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2015/01/26/jetty-connector" title="Jetty源码阅读 - connector">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
var cloudTieConfig = {
      url: document.location.href, 
        sourceId: "",
          productKey: "0fd00f73d0a349de8d748338ffe413a0",
            target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>





  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2017 Youly
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    

  </body>
</html>

