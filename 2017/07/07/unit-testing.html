

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>关于单元测试的总结及思考</title>
    
    <meta name="author" content="Youly">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Youly</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">存档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  




            <!--
            <li><a href="/resume">简历</a></li>
            -->
            <li><a href="/photos">相册</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

<div class="page-header">
  <h1>关于单元测试的总结及思考 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>07 July 2017</span>
    </div>
    <div class="content">
      <h3 id="section">什么是单元测试</h3>

<h4 id="section-1">基本概念</h4>
<p><a href="https://en.wikipedia.org/wiki/Unit_testing">点击查看</a> Wikipedia 词条，要点：</p>

<ul>
  <li>软件测试中的一种方法，验证程序运行符合预期。</li>
  <li>将程序逻辑切分成单元或者模块，按照最小单元进行测试。面向对象设计的语言中，unit 通常是一个 class/method。</li>
  <li>理想的 unit 具备良好的独立性，依赖以 mock/stub 的方式注入。关于stub和mock的区别，可以查看martinfowler的博客：<a href="https://martinfowler.com/articles/mocksArentStubs.html">Mocks Aren’t Stubs</a>。</li>
  <li>由开发人员或者白盒测试人员编写。</li>
</ul>

<p>那么如何验证程序运行是否符合预期呢？以OOP为例，对象主要由两点来描述：</p>

<ul>
  <li><em>State</em>，对象的状态，可以理解为某一时刻的属性值。</li>
  <li><em>Behavior</em>，对象的行为，接收到外部消息后进行状态变更的过程。</li>
</ul>

<p>Unit testing 可以基于这两点来做验证，即 state assert 和 behavior verification。</p>

<h4 id="section-2">单元测试在整个测试流程中的位置</h4>
<p>一般测试流程中有如下几个阶段，并按照时间顺序进行：</p>
<p align="center">
<img src="/assets/images/unit-test-2.png" alt="test" style="height: 60px;" />
</p>
<ul>
  <li>单元测试，由开发主导，验证基础单元/模块功能。</li>
  <li>集成测试，和外部环境联通，验证跨单元的功能。</li>
  <li>冒烟测试，属于端到端的测试，一般由开发主导，验证程序基本流程没问题后，再交付给测试人员进行后续测试。</li>
  <li>回归测试，由测试主导，验证新增功能是否影响原有功能。</li>
</ul>

<h3 id="section-3">单元测试的价值</h3>
<p>很多团队并不怎么看重单元测试，认为价值不大且投入精力多，这点对于具有良好质量意识的个人来说确实如此，但对于一个团队，需要更多的从管理方法上去提高整体质量。从自己写单元测试来看，我感受有以下几点价值：</p>

<ul>
  <li>测试驱动开发，而不是前端驱动。对于纯后端开发人员，写完某个功能，不必等待前端开发完一起联调，自己写单元测试效率更高。</li>
  <li>前人种树后人乘凉，完善的单元测试有利于后面做重构，降低了代码维护成本。</li>
  <li>代码质量的一个度量，数据统计方便于管理做决策。</li>
  <li>在著名的”测试金字塔”中，单元测试处于底层，相比上层的测试，单测运行快、成本低，更能指出问题所在并快速bugfix，关于这一点可以延伸阅读下：<a href="https://testing.googleblog.com/2015/04/just-say-no-to-more-end-to-end-tests.html">Google testing: Just Say No to More End-to-End Tests</a>。</li>
</ul>
<p align="center">
<img src="/assets/images/unit-test-3.png" alt="testPyramid" style="width: 350px;" />
</p>

<h3 id="section-4">实施单元测试的难点</h3>
<ul>
  <li>mock数据难，经常把单元测试写成了集成测试。</li>
  <li>需要与发布、持续集成环境整合才能体现其主动性，需要有专门的测试开发负责推进。</li>
  <li>并不是开发中必须有的一个流程，没有强制的衡量标准。</li>
  <li>对于已经发展庞大但缺失单测的项目，由于代码不符合单测工具所约定的规范，再去补充单元测试很难（亲身经历），需要对项目进行拆分及规范化。</li>
</ul>

<h3 id="section-5">如何做单元测试</h3>

<h4 id="section-6">1、制定需要遵守的规范</h4>

<ul>
  <li>代码布局</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>src/
├── main
│   ├── java
│   └── resources
└── test
	├── java
	└── resources
</code></pre>
</div>
<p>详细请参考 <a href="http://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html">maven工程标准结构</a></p>

<ul>
  <li>类、方法命名</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// 类命名以Test结尾	</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenServiceTest</span> <span class="kd">extends</span> <span class="n">AbstractTestCase</span> <span class="o">{</span>

	<span class="nd">@Resource</span>
	<span class="kd">private</span> <span class="n">TokenService</span> <span class="n">tokenService</span><span class="o">;</span>

	<span class="c1">// 方法命名以Test结尾</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">insertTest</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">MockUp</span><span class="o">&lt;</span><span class="n">TokenDao</span><span class="o">&gt;</span> <span class="n">tokenDaoMockUp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MockUp</span><span class="o">&lt;</span><span class="n">TokenDao</span><span class="o">&gt;()</span> <span class="o">{</span>
			<span class="nd">@Mock</span>
			<span class="n">Integer</span> <span class="nf">insert</span><span class="o">(</span><span class="n">Token</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">};</span>
		<span class="n">ReflectionTestUtils</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">tokenService</span><span class="o">,</span> <span class="s">"tokenDao"</span><span class="o">,</span> <span class="n">tokenDaoMockUp</span><span class="o">.</span><span class="na">getMockInstance</span><span class="o">());</span>
		<span class="n">tokenService</span><span class="o">.</span><span class="na">insert</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<ul>
  <li>代码逻辑分层，良好的分层有助于更加清晰的单元测试编写，请参考上一篇文章 <a href="http://blog.lastww.com/2017/07/03/web-service-layed-design">Web分层设计模型</a>。分层之后，每一层应该做什么？</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>1) web层
验证 PATH，REQUEST_METHOD 配置是否正确，验证 RESPONSE_CODE是否正常。这一层实际上属于端到端的测试，一般项目中很难测出问题，大部分情况下可以省略。

2) facade层
验证参数校验，数据组装转换是否符合预期。

3) service/component层
验证业务逻辑、流程是否正常，需要mock掉外部服务依赖。

4) cache层
验证缓存配置是否正常，缓存读写命令是否正常，用例需要包含清理数据的逻辑。

5) dao层
验证sql逻辑是否正确，主键是否正常。如果用到测试数据库，测试完后需要回滚数据。
</code></pre>
</div>

<ul>
  <li>与发布流程整合</li>
</ul>

<p>将单元测试集成到发布流程中，只有单测单通才能进行review和提测。</p>

<h4 id="section-7">2、选择好用的工具和框架</h4>
<p>关于有哪些工具和框架，以及优缺点，这里就不列举了，直接推荐以下两个：</p>

<ul>
  <li>TestNG: a testing framework inspired from JUnit and NUnit but introducing some new functionalities, 网站：http://testng.org/doc/</li>
  <li>jmockit: includes APIs for mocking, faking, and integration testing, and a code coverage tool. 网站：http://jmockit.org/about.html。API 介绍如下：</li>
</ul>

<p align="center">
<img src="/assets/images/unit-test-1.png" alt="jmockit" style="width: 600px;" />
</p>

<h4 id="section-8">3、定期评估</h4>

<ul>
  <li>覆盖率指标需要保持在一个固定值之上，如果下降需要有人跟进。</li>
</ul>

<h3 id="section-9">最终，别忘了</h3>
<p>单元测试不仅仅是开发的事，需要测试一起配合推动。</p>

<h3 id="section-10">参考链接</h3>

<p>1、<a href="https://martinfowler.com/bliki/TestPyramid.html">Martinfowler: TestPyramid</a></p>

<p>2、<a href="https://testing.googleblog.com/2015/04/just-say-no-to-more-end-to-end-tests.html">Google testing: Just Say No to More End-to-End Tests</a></p>

<p>3、<a href="https://stackoverflow.com/questions/520064/what-is-unit-test-integration-test-smoke-test-regression-test">What is Unit test, Integration Test, Smoke test, Regression Test?</a></p>

<p>4、<a href="http://geosoft.no/development/unittesting.html">Unit Testing Guidelines</a></p>

<p>5、<a href="https://martinfowler.com/articles/mocksArentStubs.html">Martinfowler: Mocks Aren’t Stubs</a></p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#方法论-ref">
    		方法论 <span>3</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#java-ref">java <span>8</span></a></li>
     
    	<li><a href="/tags.html#质量保障-ref">质量保障 <span>2</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2017/07/03/web-service-layed-design" title="Web服务分层设计模型">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next disabled"><a>Next &rarr;</a>
      
      </ul>
    </div>
    <hr>
    


  <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
var cloudTieConfig = {
      url: document.location.href, 
        sourceId: "",
          productKey: "0fd00f73d0a349de8d748338ffe413a0",
            target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>





  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2017 Youly
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    

  </body>
</html>

