

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>使用rabbitmq提供高可用性队列服务(1)</title>
    
    <meta name="author" content="Youly">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Youly</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">存档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  




            <!--
            <li><a href="/resume">简历</a></li>
            -->
            <li><a href="/photos">相册</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

<div class="page-header">
  <h1>使用rabbitmq提供高可用性队列服务(1) </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>30 May 2015</span>
    </div>
    <div class="content">
      <h3 id="section">为什么使用队列</h3>

<p><img src="/assets/images/queue.jpeg" alt="queue" /></p>

<p>一个复杂的业务系统，为了保证尽可能小的响应时间和高的吞吐率，必然关联到模块的解耦和业务的拆分。非核心业务异步化，保证业务的关键路径尽可能短。而解耦和异步化的一个实现方式就是消息中间件。通过消息来连接不同的业务，在扩展性，系统稳定性上提供了一个很好的解决方案。</p>

<h3 id="rabbitmq">为什么是rabbitmq</h3>

<p>1、支持<a href="http://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol">AMQP</a></p>

<p>2、消息可靠性：发送确认、接收回执、消息落地、高可用性</p>

<p>3、灵活的路由方式：点对点、广播，基于正则的转发</p>

<p>4、服务集群，节点间共享用户、队列、exchange等，节点间负载能够均衡</p>

<p>5、消息的高可用性：分布式的架构，以牺牲网络分区的代价，换来服务的高可用性和数据一致性</p>

<p>6、提供web的管理界面</p>

<p>7、提供多语言的客户端</p>

<h3 id="cap-theorem">cap theorem</h3>

<p>分布式服务架构需要参考的一个<a href="http://en.wikipedia.org/wiki/CAP_theorem">重要定理</a>，在一个分布式的系统中，不可能同时达到以下三点：</p>

<p>1、一致性，所有节点在同一时刻保持着同样的状态</p>

<p>2、可用性，保证所有的请求都有一个响应</p>

<p>3、分区容忍，即使某个分区失败，还能持续提供服务</p>

<p>rabbitmq提供的高可用集群参考了这一理论，提供一致性的数据、高可用性的服务，但却牺牲了分区容忍。</p>

<p>这里提到cap theorem，只是了解，并未作深入研究。</p>

<h3 id="rabbitmq-1">rabbitmq集群</h3>

<p>由多个rabbitmq节点组成逻辑上的一个节点，每个节点间共享用户、vhost、队列信息、exchange等。除了队列的消息（只存储在创建此队列的节点上），其他所有对数据、状态的更新在每个节点中都执行了一遍。因此，无论连接集群中的那个节点，都能得到一致的结果。通常集群的部署方式如下：</p>

<p><img src="/assets/images/rabbitmq_ha.png" alt="rabbitmq_ha" /></p>

<p>实际上，rabbitmq的集群仅仅是提供了扩展性，能够在多节点间负载均衡，但消息仅仅是存储在其中一台节点，一旦这台节点挂掉，关联此队列的所有服务就不能用了。</p>

<p>###rabbitmq集群高可用性</p>

<p>通过设置policy，将队列消息镜像到所有节点，消息的发布与删除，都能同步到各个节点。这样，当master节点挂掉，可以从salve节点中再推举一台作为master。</p>

<p>针对此点，在运维rabbitmq集群过程中，需要注意到以下几点：</p>

<p>1、last shutdown, first startup</p>

<p>2、加入一个新的节点（salve），尽量不要显示地同步队列数据，那样会中断此队列的服务，让salve自然同步</p>

<p>3、不要将集群节点部署到跨网段里。</p>

<p>4、重启一个salve节点，其持久保存的数据将被丢弃。</p>

<p>5、需要移除master节点或者选择一个新的master时，要执行 rabbitmqctl forget_cluster_node，然后才启动salves。</p>

<h3 id="rabbitmq-2">rabbitmq集群搭建</h3>

<p>请参考<a href="/2015/06/06/rabbitmq-cluster-with-high-availability-2">下一篇文章</a></p>

<h3 id="section-1">参考</h3>
<p>1、<a href="https://www.rabbitmq.com/clustering.html">Rabbitmq Clustering Guide</a></p>

<p>2、<a href="http://www.rabbitmq.com/ha.html">Rabbitmq Highly Available Queues</a></p>


    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#分布式-ref">
    		分布式 <span>2</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#queue-ref">queue <span>2</span></a></li>
     
    	<li><a href="/tags.html#rabbitme-ref">rabbitme <span>2</span></a></li>
     
    	<li><a href="/tags.html#ha-ref">ha <span>2</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2015/02/04/difference-between-java-lock-and-synchronized" title="synchronized与lock的区别">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2015/06/06/rabbitmq-cluster-with-high-availability-2" title="使用rabbitmq提供高可用性队列服务(2)">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
var cloudTieConfig = {
      url: document.location.href, 
        sourceId: "",
          productKey: "0fd00f73d0a349de8d748338ffe413a0",
            target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>





  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2017 Youly
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    

  </body>
</html>

