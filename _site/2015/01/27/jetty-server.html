

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Jetty源码阅读 - server</title>
    
    <meta name="author" content="Youly">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Youly</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">存档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  




            <!--
            <li><a href="/resume">简历</a></li>
            -->
            <li><a href="/photos">相册</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

<div class="page-header">
  <h1>Jetty源码阅读 - server </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>27 January 2015</span>
    </div>
    <div class="content">
      <p>接着上篇<a href="/2015/01/26/jetty-connector/">Jetty源码阅读 - connector</a>，本文将分析jetty组件中server组件的源码，基于jetty-9.3.0。</p>

<h3 id="server">什么是Server</h3>

<p>Jetty由若干个组件组成，Server则把这些组件关联起来，对外提供服务的接口，其在jetty整个架构中的位置如下：</p>

<p><img src="/assets/images/jetty-high-level-architecture.png" alt="jetty-high-level-architecture" /></p>

<p>继承自HandlerWrapper，关联connector，server在这两者之间处于一种协调关系。</p>

<h3 id="server-1">Server类图</h3>

<p><img src="/assets/images/jetty_server.jpg" alt="jetty server" /></p>

<p>其中蓝色的线代表“类继承”，绿色实线代表“接口继承”，绿色虚线代表“接口实现”。</p>

<p>从上图可以看到，server和handler的关系与server和connector的关系不同， server类和handler类是继承关系，而不是关联关系。</p>

<h3 id="server-2">Server源码分析</h3>

<p>1）server类初始化，需要四个信息，监听ip，监听port，connector组件以及线程池。如下是其中的一个构造函数（文件org.eclipse.jetty.server.Server）：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public Server(@Name("address")InetSocketAddress addr)
{
    this((ThreadPool)null);
    ServerConnector connector=new ServerConnector(this);
    connector.setHost(addr.getHostName());
    connector.setPort(addr.getPort());
    setConnectors(new Connector[]{connector});
}
</code></pre>
</div>

<p>2）默认的线程池实现是org.eclipse.jetty.util.thread.QueuedThreadPool，线程池中的每个线程不断地从队列中取任务，然后执行。队列采用的是ConcurrentLinkedQueue。</p>

<p>3）Server类继承了ContainerLifeCycle，因此它也有容器的属性，包括启动、停止等。它也管理着与容器生命周期有关的bean，如threadpool，connector。当server类start的时候，会先调用threadpool、connector的start方法。</p>

<p>4）当connector组件接收一个连接并解析完http数据时，会将解析完后封装到HttpChannel的请求信息交给server处理。server则调用handler方法：</p>

<p>文件org.eclipse.jetty.server.Server：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public void handle(HttpChannel connection) throws IOException, ServletException
{
    final String target=connection.getRequest().getPathInfo();
    final Request request=connection.getRequest();
    final Response response=connection.getResponse();

    if (LOG.isDebugEnabled())
        LOG.debug(request.getDispatcherType()+" "+request.getMethod()+" "+target+" on "+connection);

    if ("*".equals(target))
    {
        handleOptions(request,response);
        if (!request.isHandled())
            handle(target, request, request, response);
    }
    else
        handle(target, request, request, response);

    if (LOG.isDebugEnabled())
        LOG.debug("RESPONSE "+target+"  "+connection.getResponse().getStatus()+" handled="+request.isHandled());
}
</code></pre>
</div>

<p>文件org.eclipse.jetty.server.handler.HandlerWrapper：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>@Override
public void handle(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException
{
    if (_handler!=null &amp;&amp; isStarted())
    {
        _handler.handle(target,baseRequest, request, response);
    }
}
</code></pre>
</div>

<h3 id="section">参考</h3>

<p>1、<a href="http://www.eclipse.org/jetty/documentation/current/architecture.html#basic-architecture">Jetty Architecture</a></p>


    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#源码-ref">
    		源码 <span>2</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#jetty-ref">jetty <span>2</span></a></li>
     
    	<li><a href="/tags.html#java-ref">java <span>8</span></a></li>
     
    	<li><a href="/tags.html#nio-ref">nio <span>2</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2015/01/26/jetty-connector" title="Jetty源码阅读 - connector">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2015/02/04/difference-between-java-lock-and-synchronized" title="synchronized与lock的区别">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
var cloudTieConfig = {
      url: document.location.href, 
        sourceId: "",
          productKey: "0fd00f73d0a349de8d748338ffe413a0",
            target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>





  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2017 Youly
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    

  </body>
</html>

