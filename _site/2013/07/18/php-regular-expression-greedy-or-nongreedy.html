

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>php正则表达式-非贪婪匹配和递归匹配</title>
    
    <meta name="author" content="Youly">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Youly</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">存档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  




            <!--
            <li><a href="/resume">简历</a></li>
            -->
            <li><a href="/photos">相册</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

<div class="page-header">
  <h1>php正则表达式-非贪婪匹配和递归匹配 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>18 July 2013</span>
    </div>
    <div class="content">
      <h3 id="section">贪婪匹配与非贪婪匹配</h3>

<p>php中所有的正则表达式默认都是贪婪的，即一个标识符（如*）会尽可能多地匹配字符。</p>

<p>举个例子，如模式p*，它先匹配一个p，然后是0个或者多个字符。对于字符串“php”。在贪婪模式下，它能找到一个匹配，首先它匹配一个p，接着它匹配hp。而在非贪婪模式下，它能找到两个匹配。开始他能匹配p然后h，但是接下来它并不是继续匹配p，而是把最后一个p留下，当做下一次匹配的开始。看下面的代码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//preg_match_all函数输出匹配到的个数
$match = array();
print preg_match_all('/p.*/', "php", $match);  // 贪婪，输出1
print preg_match_all('/p.*?/', "php", $match); // 非贪婪，输出2
</code></pre>
</div>

<p>贪婪匹配也叫最大匹配，非贪婪匹配又名最小匹配。再看另外一个例子：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>贪婪模式下：
$html = '&lt;b&gt;I am bold.&lt;/b&gt; &lt;i&gt;I am italic.&lt;/i&gt; &lt;b&gt;I am also bold.&lt;/b&gt;';
preg_match_all('/&lt;b&gt;(.+)&lt;/b&gt;/', $html, $bolds);
print_r($bolds[1]);
Array
(
    [0] =&gt; I am bold.&lt;/b&gt; &lt;i&gt;I am italic.&lt;/i&gt; &lt;b&gt;I am also bold.

)

非贪婪模式下：
$html = '&lt;b&gt;I am bold.&lt;/b&gt; &lt;i&gt;I am italic.&lt;/i&gt; &lt;b&gt;I am also bold.&lt;/b&gt;';
preg_match_all('/&lt;b&gt;(.+?)&lt;/b&gt;/', $html, $bolds);
print_r($bolds[1]);
Array
(
    [0] =&gt; I am bold.
    [1] =&gt; I am also bold.
)
</code></pre>
</div>

<p>再来看一个更复杂的，为了方便阅读拆分成多段：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    const URL_REGEXP = '/
    	^(\/[\d]+)?
    	\/([^\d\?\/\\][^\/]*?)?
    	(?:\/([^\?\/\\][^\/]*?))?
    	(?:\/([^\?]+?))?
    	(?:\/?\?.*)?
    $/is';
</code></pre>
</div>

<p>这个正则表达式的状态转换图是：
<img src="/assets/images/regularexperssion.jpg" alt="状态转换图" /></p>

<p>假设带匹配的字符串 $str = /a/b/,通过上面的正则表达式匹配到的结果是什么呢？</p>

<p>?:表示只匹配不捕获，也就是不会出现在结果中。对于$str,它的匹配结果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>array(5) {
  [0]=&gt;
  string(5) "/a/b/"
  [1]=&gt;
  string(0) ""
  [2]=&gt;
  string(1) "a"
  [3]=&gt;
  string(0) "" //这个为什么是空呢？
  [4]=&gt;
  string(2) "b/"
} 刚开始没搞懂为什么匹配到的结果是这个，后来和同事在邮件中讨论才搞明白，一下是邮件原文：
</code></pre>
</div>

<blockquote>
  <p><img src="/assets/images/regularexperssion2.png" alt="正则表达式" />
含“?:”的括号中表达式只匹配不捕获（non-capturing subpatterns），</p>
</blockquote>

<blockquote>
  <p>匹配“/a”后分析表达式       (?:\/([^\?\/\][^\/]*?))?</p>
</blockquote>

<blockquote>
  <p>根据默认的贪婪原则，括号后“?”先尝试匹配1次括号中表达式</p>
</blockquote>

<blockquote>
  <p>根据非贪婪原则，”*?”先尝试匹配0次”[^\/]”，即匹配”/b”，但这样匹配后，后面的正则表达式无法成功匹配剩下的”/”，所以回溯</p>
</blockquote>

<blockquote>
  <p>”*?”尝试匹配1次”[^\/]”，无法匹配 “/b/”，。。。</p>
</blockquote>

<blockquote>
  <p>“匹配1次括号中表达式”失败，进行回溯</p>
</blockquote>

<blockquote>
  <p>括号后“?”尝试匹配0次，即该表达式匹配空字符串，其中红色部分为不含“?:”的第三个括号，所以匹配结果中第3个为空（去掉“?:”后该表达式两个括号结果都为空）</p>
</blockquote>

<blockquote>
  <p>感觉贪婪、非贪婪匹配纠结的地方是 需要在整个正则表达式成功匹配的前提下 使子模式尽可能多（少）的匹配，否则需要回溯，直到匹配成功</p>
</blockquote>

<h3 id="section-1">递归匹配</h3>

<p>递归匹配用符号(?R)来表示，指正则表达式本身。php文档里的<a href="http://php.net/manual/en/regexp.reference.recursive.php">描述</a>:</p>

<blockquote>
  <p>Consider the problem of matching a string in parentheses, allowing for unlimited nested parentheses. Without the use of recursion, the best that can be done is to use a pattern that matches up to some fixed depth of nesting.</p>
</blockquote>

<p>看下面的代码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$str = '{"name":"percent_param", "default":{"24小时回复率":["24小时回复量","售后平台维权量"]}}';
preg_match_all("/{[^{}]*((?R)*)}/", $str, $t);
var_dump($t);
</code></pre>
</div>

<p>打印结果：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>array(2) {
  [0]=&gt;
  array(1) {
    [0]=&gt;
    string(103) "{"name":"percent_param", "default":{"24小时回复率":["24小时回复量","售后平台维权量"]}}"
  }
  [1]=&gt;
  array(1) {
    [0]=&gt;
    string(67) "{"24小时回复率":["24小时回复量","售后平台维权量"]}"
  }
}
</code></pre>
</div>

<p>这里要理解为什么$t[1] = {“24小时回复率”:[“24小时回复量”,”售后平台维权量”]}。如果把正则表达式改成”/{[^{}]<em>(?R</em>)}/”呢？结果就很明显了，$t[1]是正则表达式匹配迭代中最后一次的捕获结果。</p>

<blockquote>
  <p><span style="color:red">PREG_PATTERN_ORDER:Orders results so that $matches[0] is an array of full pattern matches, $matches[1] is an array of strings matched by the first parenthesized subpattern, and so on.If no order flag is given, PREG_PATTERN_ORDER is assumed.</span></p>
</blockquote>

<h3 id="section-2">参考链接</h3>
<p>1、<a href="http://docstore.mik.ua/orelly/webprog/pcook/ch13_05.htm">Choosing Greedy or Nongreedy Matches</a></p>

<p>2、<a href="http://iregex.org/blog/recursive-regex-in-php.html">PHP中的递归正则</a></p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#php-ref">
    		php <span>1</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#php-ref">php <span>5</span></a></li>
     
    	<li><a href="/tags.html#正则-ref">正则 <span>1</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2013/07/09/load-blance-algorithm" title="负载均衡算法一览">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2013/07/20/make-your-own-php-mvc-framework" title="一个简单的php-mvc框架实现">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
var cloudTieConfig = {
      url: document.location.href, 
        sourceId: "",
          productKey: "0fd00f73d0a349de8d748338ffe413a0",
            target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>





  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2017 Youly
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    

  </body>
</html>

