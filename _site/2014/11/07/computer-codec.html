

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>计算机编码</title>
    
    <meta name="author" content="Youly">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Youly</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">存档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  




            <!--
            <li><a href="/resume">简历</a></li>
            <li><a href="/photos">相册</a></li>
            -->
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

<div class="page-header">
  <h1>计算机编码 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>07 November 2014</span>
    </div>
    <div class="content">
      <h3 id="section">遇到的情况</h3>
<p>用户给商品添加评价，结果报错：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>uncategorized SQLException for SQL []; SQL state [HY000]; error code [1366]; Incorrect string value: '\xF0\x9F\x8E\x81\xE7\x9A...'
</code></pre>
</div>

<p>java后端采用utf8编码，mysql也采用utf8编码，都正常，怎么会报错呢？</p>

<p>先来看看 '\xF0\x9F\x8E\x81\xE7\x9A…'是什么：</p>

<p>使用python，将字节还原成unicode编码，然后再打印出来：</p>

<p><img src="/assets/images/unicode.png" alt="unicode" /></p>

<p>去<a href="http://www.utf8-chartable.de/unicode-utf8-table.pl">这里</a>查询知道，\U0001f381 代表 WRAPPED PRESENT，以utf8编码后16进制为：f0 9f 8e 81， 长度为四个字节，再去mysql官网<a href="http://dev.mysql.com/doc/refman/5.5/en/charset-unicode-utf8.html">查询</a>, mysql的utf8编码实际仅仅支持最多3个字节的编码！</p>

<p>如何解决这个问题呢？可以设置Mysql服务器编码为utf8mb4，也可以在业务层过滤掉超过四个字节的编码。</p>

<p>把unicode范围\u0000-\uFFFF内的字符替换掉，来自stackoversflow的<a href="http://stackoverflow.com/questions/14981109/checking-utf-8-data-type-3-byte-or-4-byte-unicode">代码</a>：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public static String withNonBmpStripped( String input ) {
        if( input == null ) throw new IllegalArgumentException("input");
            return input.replaceAll("[^\\u0000-\\uFFFF]", "");
}
</code></pre>
</div>

<p>或者使用java内置的方法：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public static boolean isEntirelyInBasicMultilingualPlane(String text) {
    for (int i = 0; i &lt; text.length(); i++) {
        if (Character.isSurrogate(text.charAt(i))) {
            return false;
        }
    }
    return true;
}
</code></pre>
</div>

<h3 id="section-1">什么是编码</h3>

<p>信息是什么？对计算机来说，是一系列的0、1串，而对于人来说，则是一系列可以理解的数字、符号、表情等。</p>

<p>所谓编码(codec)，是以某种规则（映射关系）把信息从一种形式对应到另外一种形式的过程。</p>

<h3 id="section-2">字符集</h3>
<p>字符集，信息表示形式的集合。字符集的概念依托于编码(codec)，有了编码才会有字符集。每种编码都有一个有限的表示集合。比如二进制编码的字符集是{0, 1}，gbk编码的字符集是一系列的中文符号。</p>

<h3 id="section-3">二进制文件与文本文件</h3>
<p>二进制文件可以包含任何形式的数据，比如图形、声音，以二进制编码。</p>

<p>文本文件是某种字符编码的文件，仅仅包含这个编码字符集内的字符，例如ASCII文本文件里面不会出现超过127的字符。</p>

<h3 id="unicodeutf-8utf-16">Unicode与UTF-8、UTF-16</h3>
<p>Unicode， 统一（唯一）编码，能表示所有字符的字符集，不仅仅局限于某国语言。</p>

<p>Unicode仅仅是一个概念，不能被电脑表示、不能用来传输，于是就有了UTF(Unicode Transfer Format)，将unicode安装某种规则转换成1到6个字节。</p>

<h3 id="section-4">源文件编码</h3>
<p>源文件编码(source code encode)， 由操作系统默认编码和编辑器决定。编写完代码点击保存时，编辑器会以特定的编码（通常是操作系统默认编码）来保存文件。</p>

<p>有的编辑器会在源文件开头增加编码标识，以便读取时以此种编码标识解码。</p>

<h3 id="section-5">运行时编码</h3>
<p>程序运行时采用的一种编码，相对程序来说，通常与源文件编码不同。如python运行时以unicode来表示所有的字符。</p>

<h3 id="section-6">参考</h3>
<p>1、<a href="http://pythonic.zoomquiet.io/data/20110415091609/index.html">All About Python and Unicode</a></p>

<p>2、<a href="http://www.utf8-chartable.de/unicode-utf8-table.pl">Unicode-utf8字符表</a></p>

<p>3、<a href="http://en.wikipedia.org/wiki/Plane_(Unicode)">Wikipedia:Plane_Unicode</a></p>

<p>4、<a href="http://dev.mysql.com/doc/refman/5.5/en/charset-unicode-utf8.html">Mysql The utf8 Character Set (3-Byte UTF-8 Unicode Encoding)</a></p>


    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#原来如此-ref">
    		原来如此 <span>3</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#编码-ref">编码 <span>2</span></a></li>
     
    	<li><a href="/tags.html#python-ref">python <span>1</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2014/10/19/bridge-tunnel" title="网络基础-bridge和tunnel">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2014/11/18/jvm-local-cache" title="jvm本地缓存的实现">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
var cloudTieConfig = {
      url: document.location.href, 
        sourceId: "",
          productKey: "0fd00f73d0a349de8d748338ffe413a0",
            target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>





  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2017 Youly
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    


  <script>
var _hmt = _hmt || [];
(function() {
      var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?8ad091ba703da2d2c2faef990fbc91f0";
          var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
})();
</script>






  </body>
</html>

