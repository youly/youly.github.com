

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>使用zookeeper实现动态配置管理</title>
    
    <meta name="author" content="Youly">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Youly</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">存档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  




            <!--
            <li><a href="/resume">简历</a></li>
            <li><a href="/photos">相册</a></li>
            -->
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

<div class="page-header">
  <h1>使用zookeeper实现动态配置管理 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>28 November 2014</span>
    </div>
    <div class="content">
      <h3 id="section">目标</h3>
<p>1、在内存中存储一套配置，业务逻辑每次从JVM本地内存中读取配置然后执行相应逻辑</p>

<p>2、修改配置，不重启JVM，业务逻辑下次读取配置时能感知到变化</p>

<p>3、多个JVM能共享这套配置</p>

<h3 id="section-1">实现</h3>
<p>实现上述目标，可以把配置写在数据库中，每次修改配置，更新数据表相应字段即可。但若业务需频繁读取此配置，则会增加额外的性能开销。</p>

<p>利用ZooKeeper的watcher机制能很好的实现上述目标：在zookeep中新建配置根节点，在根节点下初始化配置。虽然zookeeper支持类似文件系统的目录结构，但实现这套配置管理，只需支持根节点下面一层。每次有配置变更，重新加载所有配置，以减少内存中数据与zookeeper中数据不一致的可能。</p>

<p>代码主要分成两部分：</p>

<p>1、处理zookeeper连接断开、数据更新等事件通知，保证与zookeeper的连接始终有效：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>@Override
public void process(WatchedEvent event) {

    log.debug("received event:" + event.toString());

    switch (event.getType()) {
        case None:
            switch (event.getState()) {
                case Expired:
                    log.debug("expired:" + this.zooKeeper.getSessionId());
                    try {
                        this.zooKeeper.close();
                        this.zooKeeper = createZooKeeper();
                        this.monitor();
                    } catch (Exception e) {
                        throw new RuntimeException(e);
                    }
                    break;
                case Disconnected:
                    log.debug("disconnected:" + this.zooKeeper.getSessionId());
                    try {
                        this.zooKeeper.close();
                        this.zooKeeper = createZooKeeper();
                        this.monitor();
                    } catch (Exception e) {
                        throw new RuntimeException(e);
                    }
                    break;
                case SyncConnected:
                    countDownLatch.countDown();
                    break;
            }
            break;
        case NodeChildrenChanged:
            //节点删除、创建同时会促发上层节点NodeChildrenChanged事件，因此可忽略
            //case NodeDeleted:
            //case NodeCreated:
        case NodeDataChanged:
            if (!this.zooKeeper.getState().isAlive()) {
                try {
                    this.zooKeeper = createZooKeeper();
                } catch (Exception e) {
                    throw new RuntimeException(e);
                }
            }
            this.monitor();
            break;
    }
}
</code></pre>
</div>

<p>2、加载配置数据并重新注册watcher：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    public void monitor() {
        //更新数据并注册watcher
        try {
            // 监听根节点数据变更、创建、删除
            this.zooKeeper.getData("/root", true, null);
            // 监听子节点数据更新、创建、删除
            List&lt;String&gt; children = this.zooKeeper.getChildren("/root", true);
            for (String child : children) {
                this.zooKeeper.getData("/root/" + child, true, null);
            }
        } catch (KeeperException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
</code></pre>
</div>

<p>完整代码点<a href="https://github.com/youly/study/blob/master/src/main/java/com/lastww/study/zookeeper/ZookeeperEventContainer.java">这里</a></p>

<h3 id="zookeeper">使用zookeeper需注意的几点</h3>

<p>1、收到zookeeper节点数据变更事件后需要重新注册watcher，否则之后不会再收到通知</p>

<p>2、与zookeeper的连接断开后，在session timeout之前可以重新连接</p>

<p>3、节点的版本变更后，即使数据不变，也会收到通知</p>

<h3 id="section-2">参考</h3>
<p>1、<a href="http://jm-blog.aliapp.com/?p=1384">ZooKeeper FAQ</a></p>

<p>2、https://cwiki.apache.org/confluence/display/ZOOKEEPER/FAQ</p>


    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#设计-ref">
    		设计 <span>7</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#zookeeper-ref">zookeeper <span>1</span></a></li>
     
    	<li><a href="/tags.html#config-ref">config <span>1</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2014/11/18/jvm-local-cache" title="jvm本地缓存的实现">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2014/12/04/spring-transaction" title="使用spring声明式事务">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
var cloudTieConfig = {
      url: document.location.href, 
        sourceId: "",
          productKey: "0fd00f73d0a349de8d748338ffe413a0",
            target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>





  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2017 Youly
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    


  <script>
var _hmt = _hmt || [];
(function() {
      var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?8ad091ba703da2d2c2faef990fbc91f0";
          var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
})();
</script>






  </body>
</html>

